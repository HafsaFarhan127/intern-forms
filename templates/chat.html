<!DOCTYPE html>
<html>
<head>
    <title>UBS Form Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <button class="new-chat-btn" onclick="startNewChat()">New Chat</button>
            <div id="chat-list">
                {% for chat in all_chats %}
                <div class="chat-item" onclick="loadChat('{{ chat.id }}')">
                    <small>{{ chat.timestamp }}</small><br>
                    {{ chat.preview }}
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="main-content">
            <div class="chat-container" id="chat-container">
                {% for message in chat_history %}
                <div class="message user-message">{{ message.user_query }}</div>
                <div class="message bot-message">{{ message.bot_response }}</div>
                {% endfor %}
            </div>
            <div class="input-container">
                <input type="text" id="user-input" class="chat-input" 
                       placeholder="Ask about forms..." 
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                <button class="send-button" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        function sendMessage() {
            const input = document.getElementById('user-input');
            const query = input.value.trim();
            if (!query) return;

            addMessage(query, true);
            input.value = '';

            fetch('/query', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ query: query })
            })
            .then(response => response.json())
            .then(data => {
                addMessage(data.response, false);
                scrollToBottom();
            })
            .catch(error => console.error('Error:', error));
        }

        function addMessage(text, isUser) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            div.textContent = text;
            container.appendChild(div);
        }

        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }

        function startNewChat() {
            fetch('/new_chat')
                .then(response => response.json())
                .then(() => window.location.reload());
        }

        function loadChat(chatId) {
            fetch(`/chat/${chatId}`)
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('chat-container');
                    container.innerHTML = '';
                    data.history.forEach(msg => {
                        addMessage(msg.user_query, true);
                        addMessage(msg.bot_response, false);
                    });
                    scrollToBottom();
                });
        }
    </script>
</body>
</html>